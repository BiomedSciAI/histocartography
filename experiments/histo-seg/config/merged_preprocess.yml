pipeline:
  inputs:
  - path
  - annotation_path
  stages:
    - io:
        class: ImageLoader
        inputs:
        - path
        outputs:
        - image
    - stain_normalizers:
        class: VahadaneStainNormalizer
        inputs:
        - image
        outputs:
        - normalized_image
        params:
          target: ZT76_39_B_2_1
    - tissue_mask:
        class: BrightnessThresholdTissueMask
        inputs:
        - normalized_image
        outputs:
        - tissue_mask
        params:
          blur_size: 25
          dilation_steps: 5
          erosion_steps: 10
          kernel_size: 20
    - superpixel:
        class: ColorMergedSuperpixelExtractor
        inputs:
        - normalized_image
        outputs:
        - merged_superpixels
        - initial_superpixels
        - mapping
        params:
          threshold: 0.01
          downsampling_factor: 4
          compactness: 30
          nr_superpixels: 500
    - feature_extraction:
        class: AugmentedDeepFeatureExtractor
        inputs:
        - normalized_image
        - initial_superpixels
        outputs:
        - features
        params:
          architecture: mobilenet_v2
          rotations:
            - 0
            - 90
            - 180
            - 270
          flips:
            - 'n'
            - 'h'
          num_workers: 0
          normalizer:
            type: imagenet
            mean:
              - 0.485
              - 0.456
              - 0.406
            std:
              - 0.229
              - 0.224
              - 0.225
          mask: False
          size: 224
          downsample_factor: 1
    - feature_extraction:
        class: AverageFeatureMerger
        inputs:
        - features
        - mapping
        outputs:
        - merged_features
    - io:
        class: ImageLoader
        inputs:
        - annotation_path
        outputs:
        - annotation
    - graph_builders:
        class: RAGGraphBuilder
        inputs:
        - merged_superpixels
        - merged_features
        - annotation
        outputs:
        - graph
        params:
          nr_classes: 5
          hops: 1
    - stats:
        class: GraphDiameter
        inputs:
        - graph
        outputs:
        - graph_diameter
    - stats:
        class: SuperpixelCounter
        inputs:
        - merged_superpixels
        outputs:
        - nr_superpixels
params:
  dataset: eth
  save: True
  cores: 64
  labels: True
  link_directory: null
